<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Configuring channels and the job runner &mdash; documentation Connector </title>
    
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootswatch-3.3.4/united/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/translations.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.4/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="documentation Connector " href="../index.html" />
    <link rel="next" title="Use the connector with multiprocessing workers" href="multiprocessing.html" />
    <link rel="prev" title="Amorcer la création un nouveau connecteur" href="bootstrap_connector.html" />

<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-7628916-3', 'odoo-connector.com');
  ga('send', 'pageview');
</script>

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          Odoo Connector</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
  <li class="dropdown">
    <a role="button"
       id="dLabelTranslations"
       data-toggle="dropdown"
       data-target="#"
       href="#">Translations<b class="caret"></b></a>
    <ul class="dropdown-menu"
        role="menu"
        aria-labelledby="dLabelTranslations">
      <li><a class="reference" href="http://odoo-connector.com">English</a><li>
      <li><a class="reference" href="http://odoo-connector.com/fr">French</a><li>
    </ul>
  </li>
  
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../project/contribute.html">Contribuer</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../project/contribute.html#want-to-start-a-new-connector">Démarrer un nouveau connecteur</a></li>
<li class="toctree-l2"><a class="reference internal" href="../project/contribute.html#creating-or-maintaining-a-translation-of-this-doc">Créer ou maintenir une traduction de cette doc</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../project/contributors.html">Contributeurs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../project/contributors.html#financial-contributors">Contributeurs financiers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../project/license.html">Licence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../project/changes.html">Changements</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../project/changes.html#id2">3.1.0 (2015-05-15)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../project/changes.html#id3">3.0.0 (2015-04-01)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../project/changes.html#id4">2.2.0 (2014-05-26)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../project/changes.html#id5">2.1.1 (2014-02-06)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../project/changes.html#warning-breaks-compatibility">2.1.0 (2014-01-15 - attention : rupture de compatibilité)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../project/changes.html#id6">2.0.1 (2013-09-12)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../project/changes.html#id7">2.0.0</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../project/roadmap.html">Roadmap</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="code_overview.html">Survol du code</a><ul>
<li class="toctree-l2"><a class="reference internal" href="code_overview.html#backends">Backends</a></li>
<li class="toctree-l2"><a class="reference internal" href="code_overview.html#bindings">Bindings (Liaisons)</a></li>
<li class="toctree-l2"><a class="reference internal" href="code_overview.html#session">Session</a></li>
<li class="toctree-l2"><a class="reference internal" href="code_overview.html#events">Événements</a></li>
<li class="toctree-l2"><a class="reference internal" href="code_overview.html#jobs">Jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="code_overview.html#connectorunit">ConnectorUnit</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="concepts.html">Concepts du connecteur</a><ul>
<li class="toctree-l2"><a class="reference internal" href="concepts.html#events">Événements</a></li>
<li class="toctree-l2"><a class="reference internal" href="concepts.html#jobs-queue">Queue de jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="concepts.html#session">Session</a></li>
<li class="toctree-l2"><a class="reference internal" href="concepts.html#backend">Backend</a></li>
<li class="toctree-l2"><a class="reference internal" href="concepts.html#environment">Environnement</a></li>
<li class="toctree-l2"><a class="reference internal" href="concepts.html#connectorunit">ConnectorUnit</a></li>
<li class="toctree-l2"><a class="reference internal" href="concepts.html#bindings">Bindings (Liaisons)</a></li>
<li class="toctree-l2"><a class="reference internal" href="concepts.html#checkpoint">Point de contrôle</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="bootstrap_connector.html">Amorcer la création un nouveau connecteur</a><ul>
<li class="toctree-l2"><a class="reference internal" href="bootstrap_connector.html#odoo-manifest">Odoo Manifest</a></li>
<li class="toctree-l2"><a class="reference internal" href="bootstrap_connector.html#install-the-module-in-the-connector">Installation du module dans le connecteur</a></li>
<li class="toctree-l2"><a class="reference internal" href="bootstrap_connector.html#declare-the-backends">Déclaration des backends</a></li>
<li class="toctree-l2"><a class="reference internal" href="bootstrap_connector.html#backend-model">Modèle du backend</a></li>
<li class="toctree-l2"><a class="reference internal" href="bootstrap_connector.html#abstract-binding">Binding abstrait</a></li>
<li class="toctree-l2"><a class="reference internal" href="bootstrap_connector.html#environment">Environnement</a></li>
<li class="toctree-l2"><a class="reference internal" href="bootstrap_connector.html#checkpoints">Points de contrôle</a></li>
<li class="toctree-l2"><a class="reference internal" href="bootstrap_connector.html#connectorunit-classes">Classes ConnectorUnit</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Configuring channels and the job runner</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#what-s-is-the-job-runner">What&#8217;s is the job runner?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-does-it-work">How does it work?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-use-it">How to use it?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#caveat">Caveat</a></li>
<li class="toctree-l2"><a class="reference internal" href="#notes">Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#what-is-a-channel">What is a channel?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-configure-channels">How to configure Channels?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="multiprocessing.html">Use the connector with multiprocessing workers</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/api_connector.html">Connecteur</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/api_session.html">Session</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/api_backend.html">Backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/api_backend.html#module-connector.backend_model">Modèles du backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/api_event.html">Événement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/api_binder.html">Binder (Liant)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/api_mapper.html">Mappeur</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/api_mapper.html#mappers">Mappeurs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api/api_synchronizer.html">Synchroniseur</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/api_backend_adapter.html">Adaptateur de backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/api_queue.html">Queue</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/api_queue.html#module-connector.queue.job">Job</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/api_queue.html#module-connector.queue.worker">Worker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/api_queue.html#id5">Queue</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/api_queue.html#module-connector.queue.model">Modèles</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api/api_exception.html">Exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/api_channels.html">Channels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/api_runner.html">Job Runner</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/api_runner.html#what-s-is-the-job-runner">What&#8217;s is the job runner?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/api_runner.html#how-does-it-work">How does it work?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/api_runner.html#how-to-use-it">How to use it?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/api_runner.html#caveat">Caveat</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/api_runner.html#notes">Notes</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Configuring channels and the job runner</a><ul>
<li><a class="reference internal" href="#what-s-is-the-job-runner">What&#8217;s is the job runner?</a></li>
<li><a class="reference internal" href="#how-does-it-work">How does it work?</a></li>
<li><a class="reference internal" href="#how-to-use-it">How to use it?</a></li>
<li><a class="reference internal" href="#caveat">Caveat</a></li>
<li><a class="reference internal" href="#notes">Notes</a></li>
<li><a class="reference internal" href="#what-is-a-channel">What is a channel?</a></li>
<li><a class="reference internal" href="#how-to-configure-channels">How to configure Channels?</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            

            
              
                
  <li>
    <a href="bootstrap_connector.html" title="Previous Chapter: Amorcer la création un nouveau connecteur"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Amorcer la créat...</span>
    </a>
  </li>
  <li>
    <a href="multiprocessing.html" title="Next Chapter: Use the connector with multiprocessing workers"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Use the connecto... &raquo;</span>
    </a>
  </li>
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      
  <div class="section" id="module-connector.jobrunner.runner">
<span id="configuring-channels-and-the-job-runner"></span><span id="jobrunner"></span><h1>Configuring channels and the job runner<a class="headerlink" href="#module-connector.jobrunner.runner" title="Lien permanent vers ce titre">¶</a></h1>
<div class="section" id="what-s-is-the-job-runner">
<h2>What&#8217;s is the job runner?<a class="headerlink" href="#what-s-is-the-job-runner" title="Lien permanent vers ce titre">¶</a></h2>
<p>This is an alternative to connector workers, with the goal
of resolving issues due to the polling nature of workers:</p>
<ul class="simple">
<li>jobs do not start immediately even if there is a free connector worker,</li>
<li>connector workers may starve while other workers have too many jobs enqueued,</li>
<li>connector workers require another startup script,
making deployment more difficult</li>
</ul>
<p>It is fully compatible with the connector mechanism and only
replaces workers.</p>
</div>
<div class="section" id="how-does-it-work">
<h2>How does it work?<a class="headerlink" href="#how-does-it-work" title="Lien permanent vers ce titre">¶</a></h2>
<ul class="simple">
<li>It starts as a thread in the Odoo main process</li>
<li>It receives postgres NOTIFY messages each time jobs are
added or updated in the queue_job table.</li>
<li>It maintains an in-memory priority queue of jobs that
is populated from the queue_job tables in all databases.</li>
<li>It does not run jobs itself, but asks Odoo to run them through an
anonymous /connector/runjob HTTP request [1].</li>
</ul>
</div>
<div class="section" id="how-to-use-it">
<h2>How to use it?<a class="headerlink" href="#how-to-use-it" title="Lien permanent vers ce titre">¶</a></h2>
<ul class="simple">
<li>Set the following environment variables:<ul>
<li>ODOO_CONNECTOR_CHANNELS=root:4 (or any other channels configuration)</li>
<li>optional if xmlrpc_port is not set: ODOO_CONNECTOR_PORT=8069</li>
</ul>
</li>
<li>Start Odoo with &#8211;load=web,connector and &#8211;workers &gt; 1. [2]</li>
<li>Disable then &#8220;Enqueue Jobs&#8221; cron.</li>
<li>Do NOT start openerp-connector-worker.</li>
<li>Create jobs (eg using base_import_async) and observe they
start immediately and in parallel.</li>
</ul>
</div>
<div class="section" id="caveat">
<h2>Caveat<a class="headerlink" href="#caveat" title="Lien permanent vers ce titre">¶</a></h2>
<ul class="simple">
<li>After creating a new database or installing connector on an
existing database, Odoo must be restarted for the runner to detect it.</li>
</ul>
</div>
<div class="section" id="notes">
<h2>Notes<a class="headerlink" href="#notes" title="Lien permanent vers ce titre">¶</a></h2>
<dl class="docutils">
<dt>[1] From a security standpoint, it is safe to have an anonymous HTTP</dt>
<dd>request because this request only accepts to run jobs that are
enqueued.</dd>
<dt>[2] It works with the threaded Odoo server too, although this is</dt>
<dd>obviously not for production purposes.</dd>
</dl>
</div>
<div class="section" id="what-is-a-channel">
<h2>What is a channel?<a class="headerlink" href="#what-is-a-channel" title="Lien permanent vers ce titre">¶</a></h2>
<dl class="class">
<dt id="connector.jobrunner.channels.Channel">
<em class="property">class </em><code class="descclassname">connector.jobrunner.channels.</code><code class="descname">Channel</code><span class="sig-paren">(</span><em>name</em>, <em>parent</em>, <em>capacity=None</em>, <em>sequential=False</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/connector/jobrunner/channels.html#Channel"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#connector.jobrunner.channels.Channel" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>A channel for jobs, with a maximum capacity.</p>
<p>When jobs are created by connector modules, they may be associated
to a job channel. Jobs with no channel are inserted into the root channel.</p>
<p>Job channels are joined in a hierarchy down to the root channel.
When a job channel has available capacity, jobs are dequeued, marked
as running in the channel and are inserted into the queue of the
parent channel where they wait for available capacity and so on.</p>
<p>Job channels can be visualized as water channels with a given flow
limit (= capacity). Channels are joined together in a downstream channel
and the flow limit of the downstream channel limits upstream channels.:</p>
<div class="highlight-python"><div class="highlight"><pre>---------------------+
                     |
                     |
 Ch. A C:4,Q:12,R:4  +-----------------------

---------------------+  Ch. root C:5,Q:0,R:4
                     |
---------------------+
 Ch. B C:1,Q:0,R:0
---------------------+-----------------------
</pre></div>
</div>
<p>The above diagram illustrates two channels joining in the root channel.
The root channel has a capacity of 5, and 4 running jobs coming from
Channel A. Channel A has a capacity of 4, all in use (passed down to the
root channel), and 12 jobs enqueued. Channel B has a capacity of 1,
none in use. This means that whenever a new job comes in channel B,
there will be available room for it to run in the root channel.</p>
<p>Note that from the point of view of a channel, &#8216;running&#8217; means enqueued
in the downstream channel. Only jobs marked running in the root channel
are actually sent to Odoo for execution.</p>
<p>Should a downstream channel have less capacity than its upstream channels,
jobs going downstream will be enqueued in the downstream channel,
and compete normally according to their properties (priority, etc).</p>
<p>Using this technique, it is possible to enforce sequence in a channel
with a capacity of 1. It is also possible to dedicate a channel with a
limited capacity for application-autocreated subchannels
without risking to overflow the system.</p>
</dd></dl>

</div>
<div class="section" id="how-to-configure-channels">
<h2>How to configure Channels?<a class="headerlink" href="#how-to-configure-channels" title="Lien permanent vers ce titre">¶</a></h2>
<p>The <code class="docutils literal"><span class="pre">ODOO_CONNECTOR_CHANNELS</span></code> environment variable must be
set before starting Odoo in order to enable the job runner
and configure the capacity of the channels.</p>
<p>The general syntax is <code class="docutils literal"><span class="pre">channel(.subchannel)*(:capacity(:key(=value)?)*)?,...</span></code>.</p>
<p>Intermediate subchannels which are not configured explicitly are autocreated
with an unlimited capacity (except the root channel which if not configured gets
a default capacity of 1).</p>
<p>Example <code class="docutils literal"><span class="pre">ODOO_CONNECTOR_CHANNELS</span></code>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">root:4</span></code>: allow up to 4 concurrent jobs in the root channel.</li>
<li><code class="docutils literal"><span class="pre">root:4,root.sub:2</span></code>: allow up to 4 concurrent jobs in the root channel and
up to 2 concurrent jobs in the channel named <code class="docutils literal"><span class="pre">root.sub</span></code>.</li>
<li><code class="docutils literal"><span class="pre">sub:2</span></code>: the same.</li>
</ul>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
<div id="sourcelink">
  <a href="../_sources/guides/jobrunner.txt"
     rel="nofollow">Source</a>
</div>
      
    </p>
    <p>
        &copy; Copyright 2013, Camptocamp SA.<br/>
      Créé avec <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>